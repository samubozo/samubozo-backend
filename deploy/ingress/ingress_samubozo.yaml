apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: samubozo-ingress
  annotations:
    # 인증서 발급 로직을 담당하는 cert-manager에게 letsencrypt-prod라는 도구를 이용해서 인증서를 발급 받어라.
    # Let's Encrypt는 무료 SSL 인증서를 발급해주는 유명한 기관
    cert-manager.io/cluster-issuer: letsencrypt-prod
    nginx.ingress.kubernetes.io/backend-protocol: "HTTP"
    # Ingress가 클라이언트와 통신할 때 HTTP/1.1을 사용하도록 설정
    nginx.ingress.kubernetes.io/server-snippet: |
      listen 443 http2;
      listen 443 ssl;
    # http 요청이 들어오면 자동으로 https로 리다이렉트(응답 및 재요청) 처리해라.
    nginx.ingress.kubernetes.io/ssl-redirect: 'true'
    # Read timeout 설정: 서버가 응답을 읽는 시간 (SSE의 경우 중요)
    nginx.ingress.kubernetes.io/proxy-read-timeout: "60"
    # Send timeout 설정: 서버가 요청을 보내는 시간
    nginx.ingress.kubernetes.io/proxy-send-timeout: "60"

spec:
  # 설치한 ingress controller의 종류를 명시 -> 우리가 설치한 게 nginx라는 도구를 사용한 ingress
  # nginx: 정적 웹 서버(오픈소스). 웹사이트 호스팅, 로드 밸런싱 등에 사용되는 서버.
  ingressClassName: nginx
  # 특정 도메인에 대한 보안 설정 (HTTPS) 등록
  # api-playdatashop-tls라는 secret 오브젝트에 발급받은 인증서를 저장 -> HTTPS 연결 처리
  tls:
    - hosts:
        - apiv1.samubozo.co.kr
      secretName: api-samubozo-cert
  rules:
    - host: apiv1.samubozo.co.kr
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: gateway-service
                port:
                  number: 8000